#!/bin/bash

# Read the KAFKA_BROKERS environment variable and split it into an array
IFS=',' read -r -a kafkaBrokers <<< "$KAFKA_BROKERS"

# Function to check Kafka broker connectivity and existence of 'cve' topic
check_kafka() {
  for broker in "${kafkaBrokers[@]}"; do
    # List topics in the Kafka broker
    topics=$(/opt/kafka_2.13-3.4.0/bin/kafka-topics.sh --bootstrap-server "$broker" --list 2>/dev/null)
    if echo "$topics" | grep -q "^cve$"; then
      echo "Kafka broker $broker is reachable and topic 'cve' exists"
      return 0
    else
      echo "Kafka broker $broker is reachable but topic 'cve' does not exist"
    fi
  done
  echo "No Kafka brokers are reachable or topic 'cve' does not exist"
  return 1
}

# Function to check PostgreSQL connectivity
check_postgres() {
  pg_isready -d $DB_URL > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    echo "PostgreSQL is reachable"
    return 0
  else
    echo "PostgreSQL is not reachable"
    return 1
  fi
}

# Check both Kafka and PostgreSQL
if check_kafka; then
  check_postgres
else
  echo "Kafka check failed, skipping PostgreSQL check"
  exit 1
fi
